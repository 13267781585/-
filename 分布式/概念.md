# 分布式基础概念

## 容灾模式

### 同城容灾

### 异地容灾

### 两地三中心

### 双活数据中心

### 三地五中心

### 数据复制

#### 多主复制

##### 缺点

* 主库数据同步冲突->对同一数据修改映射到一个主库/自定义冲突解决策略

#### 主从复制

##### 适用场景

* 读多写少
* 允许短暂数据同步延迟(最终一致性)

##### 缺点

* 主库故障产生的问题
  * 脑裂->任期
  * 数据丢失(在选出新主库后，如果老主库重新加入集群，新主库在此期间可能会收到冲突的写入，那这些写入该如何处理？)
  * 和外界数据一致性问题
* 主库写压力大
* 多次查询结果可能不同(从库同步进度不同)->数据时间戳/每个用户映射相同从库

#### 无主复制

数据节点n个，没有主次之分，写入时同时发给多个节点，只要收到w个节点回复认为写入成功，读取同时发给多个节点，在r个回复中选取最新的版本作为请求结果，只要满足 w+r>n,就可以保证每次读取的数据都是最新的，可以根据系统的承受能力适当调整w和r的取值(w+r<=n)，写多读少，w-，r-，读多写少，w+，r-。

##### 落后数据追赶策略

* 读修复
  当客户端并行读取多个节点时，它可以检测到任何陈旧的响应，并将新值写回到该副本。这种方法适用于读频繁的值。
* 反熵
  数据存储具有后台进程，该进程不断查找副本之间的数据差异，并将任何缺少的数据从一个副本复制到另一个副本。

##### 中间件

* Riak
* Cassandra
* Voldemort

##### 容错机制

* 高可用集群中会存在一些备用的节点(不在n的计数中)，当n个节点中部分节点发生异常时，系统无法为写和读提供w和r个成功的响应，这时候备用的节点会加入计数，保证系统可用性，直到异常的节点重新连接，备用节点会将临时写入的数据同步，在这段时间中，即使w+r>n，读取的数据也不一定是最新的。
  [无主复制](https://github.com/Vonng/ddia/blob/master/ch5.md#%E6%97%A0%E4%B8%BB%E5%A4%8D%E5%88%B6)
* 多数据中心
  * 发送给所有副本请求，但只等待本地数据中心响应确认，其他数据中心采用异步形式(Cassandra和Voldemort)
  * 只和本地数据中心交互，后台程序同步各个数据中心的数据(Riak)

## CQRS

读写分离架构，适用于对数据有多种模式读且对数据实时性没有强要求的业务场景。
[DDD 中的那些模式 — CQRS](https://zhuanlan.zhihu.com/p/115685384)
[详解 CQRS 架构模式](https://www.infoq.cn/article/wdlpjosudoga34jutys9)

## Event Sourcing

事件溯源，将系统的状态流转以一个个事件的形式记录下来，利用事件将系统状态回滚到任何一个状态。
[深入浅出Event Sourcing和CQRS](http://www.imooc.com/article/40858)

## Raft共识算法

分布式系统中对数据一致性和系统可用性的平衡，常用于数据同步。

## ETCD

基于Raft共识算法实现的KV存储系统。
[从零开始入门 K8s：手把手带你理解 etcd](https://www.infoq.cn/article/zqzelyy57xgvb6ecxcfb)

## HDFS

一种分布式文件系统，用于处理在商业硬件上运行的大型数据集。
[5分钟深入浅出 HDFS](https://zhuanlan.zhihu.com/p/20267586)

## HIVE

基于HDFS对大数据进行离线处理。

[一文带你了解什么是Hive【详细介绍】Hive与传统数据库有什么区别？](https://zhuanlan.zhihu.com/p/404590016)
[Hive 概述](https://www.sqlboy.tech/pages/eb41c7/#hive-%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%8C%BA%E5%88%AB)

## 服务雪崩
微服务中，一个或多个服务出现故障，上游服务还在不断重试，导致上游服务链上的服务请求堆积、负载增大，不断累积导致级联失败，整个系统崩溃。

## 熔断降级

### 熔断（Circuit Breaking）

系统中某个服务不可用，防止故障扩散到整个系统，短时间切断该链路，一段时间后放行部分请求进行嗅探，逐步放开限制。

### 降级（Degradation）

* 降级是指当系统压力较大或者某个服务不可用时，系统自动关闭或降低一些非核心功能，以确保核心功能的正常运行。例如，在电商平台上，为了保证用户能够正常浏览和下单，可能暂时关闭商品推荐或评论功能。
* 降级通常是预先设定的策略，可以基于多种指标触发，如响应超时、系统负载、内存占用等。与熔断不同，降级通常会长期持续，直到系统负载减少到正常水平或者故障服务恢复后人工或自动恢复服务。

### 区别

* 目的不同：
熔断主要防止系统雪崩效应，即防止局部服务故障扩散到整个系统，造成更大范围的系统崩溃。
降级主要是为了在某个服务不可用或响应时间过长时，保证整个系统的可用性（尤其是核心功能）。
* 激活条件：
熔断通常是由特定服务的错误率或超时率触发。
降级则可以基于系统整体的性能指标触发，如响应时间、系统负载、资源使用率等。
* 恢复机制：
熔断有自己的恢复机制，它会在“半开”状态下尝试恢复服务，如果成功，则关闭熔断器。
降级的恢复往往需要对系统负载下降或服务明确恢复后，人工或策略自动决定。

## RPC（Remote Procedure Call）
分布式中不同服务相互调用接口。rpc包括两部分，序列化协议和传输协议。
### 常见RPC框架

#### grpc
protobuf+http2。

#### thrift
内部实现了序列化+传输协议。

#### kitex/kite
字节自研基于thirft框架自研，在序列化/反序列化、网络epoll等方面做了优化。

## 微服务的优劣
相较于单体服务，从整个生产过程中比较两者：

### 方案设计
#### 缺点
* 分布式问题：事务、锁、消息延迟、丢失、数据一致性、原子性等，方案更加复杂，CAP、BASE理论。

### 代码编写
#### 优点
* 敏捷开发：模块清晰，减少多人开发风险

#### 缺点
* 性能劣化：接口延时
* 依赖复杂化：依赖关系复杂化->理清楚领域关系和服务边界
* 冗余：同个链路上不同服务冗余代码、重复调用->可复用组件、流程引擎编排

### 上线维护
#### 优点
* 模块化：功能模块独立，更好迭代
* 超时、限流、熔断、容灾
* 可扩展：系统更有弹性，方便针对系统性能瓶颈优化/增加机器资源

#### 缺点
* 需要有更加复杂的监控系统

### 其他